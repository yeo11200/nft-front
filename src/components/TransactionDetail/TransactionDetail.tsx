import React, { useCallback, useEffect, useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import styles from './TransactionDetail.module.scss';
import { Transaction } from '../../hooks/useXrplAccount';
import { useCryptoPrice } from '../../contexts/CryptoPriceContext';
import { convertXrpToKrw } from '../../utils/common';
import dayjs from 'dayjs';

interface Friend {
  nickname: string;
  address: string;
  emoji?: string;
}

interface TransactionDetailProps {
  isOpen: boolean;
  transaction: Transaction | null;
  isLoading?: boolean;
  error?: string | null;
  onClose: () => void;
}

const TransactionDetail: React.FC<TransactionDetailProps> = ({
  isOpen,
  transaction,
  isLoading,
  error,
  onClose,
}) => {
  const { xrpPriceInfo } = useCryptoPrice();
  const [myWalletAddress, setMyWalletAddress] = useState<string>('');
  const [friends, setFriends] = useState<Friend[]>([]);
  const [fromName, setFromName] = useState<string>('');
  const [toName, setToName] = useState<string>('');
  const [fromEmoji, setFromEmoji] = useState<string>('');
  const [toEmoji, setToEmoji] = useState<string>('');  
  const [effectiveAmount, setEffectiveAmount] = useState<number>(0);

  // ÎÇ¥ ÏßÄÍ∞ë Ï£ºÏÜåÏôÄ ÏπúÍµ¨ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    try {
      // ÎÇ¥ ÏßÄÍ∞ë Ï£ºÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
      const userInfo = localStorage.getItem('userInfo');
      if (userInfo) {
        const parsedInfo = JSON.parse(userInfo);
        setMyWalletAddress(parsedInfo.address);
      }

      // ÏπúÍµ¨ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
      const friendsData = localStorage.getItem('friends');
      if (friendsData) {
        setFriends(JSON.parse(friendsData));
      }
    } catch (error) {
      console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error);
    }
  }, []);

  // Ï£ºÏÜåÎ°ú ÏπúÍµ¨ Ï∞æÍ∏∞
  const findFriendByAddress = useCallback((address: string): Friend | null => {
    return friends.find((friend) => friend.address === address) || null;
  }, [friends]);

  // Ìä∏ÎûúÏû≠ÏÖòÏù¥ Î∞îÎÄåÎ©¥ Ïù¥Î¶Ñ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
  useEffect(() => {
    if (!transaction) return;

    // Î∞úÏã†Ïûê Ï†ïÎ≥¥
    if (transaction.fromAddress === myWalletAddress) {
      setFromName('ÎÇò');
      setFromEmoji('');
    } else {
      const fromFriend = findFriendByAddress(transaction.fromAddress);
      if (fromFriend) {
        setFromName(fromFriend.nickname);
        setFromEmoji(fromFriend.emoji || '');
      } else {
        setFromName(formatAddress(transaction.fromAddress));
        setFromEmoji('');
      }
    }

    // ÏàòÏã†Ïûê Ï†ïÎ≥¥
    if (transaction.toAddress === myWalletAddress) {
      setToName('ÎÇò');
      setToEmoji('');
    } else {
      const toFriend = findFriendByAddress(transaction.toAddress);
      if (toFriend) {
        setToName(toFriend.nickname);
        setToEmoji(toFriend.emoji || '');
      } else {
        setToName(formatAddress(transaction.toAddress));
        setToEmoji('');
      }
    }

    // Ïã§Ï†ú Í∏àÏï° Í≥ÑÏÇ∞ (Î≥¥ÎÇ∏ Í≤ΩÏö∞ ÏùåÏàò, Î∞õÏùÄ Í≤ΩÏö∞ ÏñëÏàò)
    const amount = parseFloat(transaction.amount);
    setEffectiveAmount(
      transaction.fromAddress === myWalletAddress
        ? -Math.abs(amount)
        : Math.abs(amount)
    );
  }, [transaction, myWalletAddress, friends, findFriendByAddress]);

  const formatHash = (hash: string) => {
    if (!hash) return '';
    return hash.length > 16 ? `${hash.substring(0, 8)}...${hash.substring(hash.length - 8)}` : hash;
  };

  const formatAddress = (address: string) => {
    if (!address) return '';
    return `${address.slice(0, 6)}...${address.slice(-4)}`;
  };

  // XRP ÏûîÏï° Î≥ÄÌôò Ìï®Ïàò (drops -> XRP)
  const formatXrpBalance = (balanceInDrops: string | number): string => {
    // balanceÎ•º Ïà´ÏûêÎ°ú Î≥ÄÌôòÌïòÍ≥† 1,000,000ÏúºÎ°ú ÎÇòÎàÑÏñ¥ XRP Îã®ÏúÑÎ°ú ÌëúÏãú
    const balanceInXrp = parseFloat(balanceInDrops.toString()) / 1000000;
    return balanceInXrp.toLocaleString("ko-KR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 6,
    });
  };

  const formatDate = (timestamp: string) => {
    if (!timestamp) return '';
    
    try {
      return dayjs(timestamp).format("YYYY-MM-DD (HH:mm)")
    } catch (e) {
      return timestamp;
    }
  };

  const copyToClipboard = async (text: string) => {
    try {
      await navigator.clipboard.writeText(text);
      alert('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
    } catch (err) {
      console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
    }
  };

  const openInExplorer = (txHash: string) => {
    if (!txHash) return;
    
    // Open XRP Ledger explorer for this transaction
    const explorerUrl = `https://testnet.xrpl.org/transactions/${txHash}`;
    window.open(explorerUrl, '_blank');
  };

  return (
    <AnimatePresence>
      {isOpen && (
        <div className={styles.overlay} onClick={onClose}>
          <motion.div
            className={styles.modalContainer}
            initial={{ scale: 0.9, opacity: 0, y: 20 }}
            animate={{ scale: 1, opacity: 1, y: 0 }}
            transition={{ type: 'spring', damping: 25, stiffness: 300 }}
            onClick={(e) => e.stopPropagation()}
          >
            <div className={styles.header}>
              <h2>Ìä∏ÎûúÏû≠ÏÖò ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h2>
              <button className={styles.closeButton} onClick={onClose}>√ó</button>
            </div>
            
            {transaction ? (
              <div className={styles.content}>
                <div className={`${styles.statusBadge} ${styles[transaction.status]}`}>
                  {transaction.status === 'success' ? 'ÏÑ±Í≥µ' : 'Ïã§Ìå®'}
                </div>
                
                <div className={styles.detailRow}>
                  <div className={styles.label}>Ìä∏ÎûúÏû≠ÏÖò ID</div>
                  <div className={`${styles.value} ${styles.hash}`}>
                    <span>{formatHash(transaction.hash)}</span>
                    <button
                      className={styles.copyButton}
                      onClick={() => copyToClipboard(transaction.hash)}
                    >
                      Î≥µÏÇ¨
                    </button>
                  </div>
                </div>
                
                <div className={styles.detailRow}>
                  <div className={styles.label}>Í∏àÏï°</div>
                  <div className={`${styles.value} ${styles.amount} ${effectiveAmount < 0 ? styles.negative : styles.positive}`}>
                    <span className={styles.amountIcon}>
                      {effectiveAmount < 0 ? "üí∏" : "üí∞"}
                    </span>
                    <div className={styles.amountContainer}>
                      <span className={styles.amountValue}>
                        {effectiveAmount > 0 ? "+" : ""}
                        {formatXrpBalance(effectiveAmount)} XRP
                      </span>
                      
                      {xrpPriceInfo && (
                        <span className={styles.amountInKrw}>
                          {convertXrpToKrw(
                            Math.abs(
                              parseFloat(
                                formatXrpBalance(transaction.amount)
                              )
                            ),
                            xrpPriceInfo
                          )}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
                
                <div className={styles.detailRow}>
                  <div className={styles.label}>Î≥¥ÎÇ∏ ÏÇ¨Îûå</div>
                  <div className={`${styles.value} ${styles.address}`}>
                    {fromEmoji && <span className={styles.emoji}>{fromEmoji}</span>}
                    <span className={fromName === 'ÎÇò' ? styles.isMe : ''}>
                      {fromName}
                    </span>
                    {fromName !== 'ÎÇò' && !findFriendByAddress(transaction.fromAddress) && (
                      <button
                        className={styles.copyButton}
                        onClick={() => copyToClipboard(transaction.fromAddress)}
                      >
                        Î≥µÏÇ¨
                      </button>
                    )}
                  </div>
                </div>
                
                <div className={styles.detailRow}>
                  <div className={styles.label}>Î∞õÎäî ÏÇ¨Îûå</div>
                  <div className={`${styles.value} ${styles.address}`}>
                    {toEmoji && <span className={styles.emoji}>{toEmoji}</span>}
                    <span className={toName === 'ÎÇò' ? styles.isMe : ''}>
                      {toName}
                    </span>
                    {toName !== 'ÎÇò' && !findFriendByAddress(transaction.toAddress) && (
                      <button
                        className={styles.copyButton}
                        onClick={() => copyToClipboard(transaction.toAddress)}
                      >
                        Î≥µÏÇ¨
                      </button>
                    )}
                  </div>
                </div>
                
                <div className={styles.detailRow}>
                  <div className={styles.label}>ÏãúÍ∞Ñ</div>
                  <div className={styles.value}>
                    {formatDate(transaction.timestamp)}
                  </div>
                </div>
                
                {transaction.status === 'failed' && error && (
                  <div className={`${styles.detailRow} ${styles.error}`}>
                    <div className={styles.label}>Ïã§Ìå® ÏõêÏù∏</div>
                    <div className={`${styles.value} ${styles.errorMessage}`}>
                      {error || "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò"}
                    </div>
                  </div>
                )}
                
                <div className={styles.actions}>
                  <button
                    className={styles.explorerButton}
                    onClick={() => openInExplorer(transaction.hash)}
                  >
                    ExplorerÏóêÏÑú Î≥¥Í∏∞
                  </button>
                </div>
              </div>
            ) : (
              <div className={styles.loadingContainer}>
                {isLoading ? (
                  <div className={styles.loading}>
                    <div className={styles.spinner}></div>
                    <span>Î°úÎî© Ï§ë...</span>
                  </div>
                ) : error ? (
                  <div className={styles.errorMessage}>{error}</div>
                ) : (
                  <div className={styles.errorMessage}>Ìä∏ÎûúÏû≠ÏÖò Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>
                )}
              </div>
            )}
          </motion.div>
        </div>
      )}
    </AnimatePresence>
  );
};

export default TransactionDetail; 